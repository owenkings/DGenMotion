# MARDM å¯è§†åŒ–ä»£ç è¯¦è§£

## ğŸ“ å¯è§†åŒ–ä»£ç ä½ç½®

**ä¸»è¦æ–‡ä»¶**: `/data/tiany/MARDM/utils/motion_process.py`

**æ ¸å¿ƒå‡½æ•°**: `plot_3d_motion()` (ç¬¬103-186è¡Œ)

---

## ğŸ¨ å®Œæ•´å¯è§†åŒ–ä»£ç 

```python
def plot_3d_motion(save_path, kinematic_tree, joints, title, figsize=(10, 10), fps=120, radius=4):
    """
    ç”Ÿæˆ3Däººä½“åŠ¨ä½œçš„å¯è§†åŒ–åŠ¨ç”»
    
    å‚æ•°:
        save_path: ä¿å­˜è·¯å¾„ (æ”¯æŒ.mp4æˆ–.gif)
        kinematic_tree: éª¨éª¼è¿æ¥å…³ç³»ï¼Œä¾‹å¦‚ t2m_kinematic_chain
        joints: å…³èŠ‚ç‚¹æ•°æ®ï¼Œå½¢çŠ¶ (seq_len, num_joints, 3)
        title: åŠ¨ç”»æ ‡é¢˜
        figsize: å›¾å½¢å¤§å°ï¼Œé»˜è®¤ (10, 10)
        fps: å¸§ç‡ï¼Œé»˜è®¤ 120
        radius: æ˜¾ç¤ºèŒƒå›´åŠå¾„ï¼Œé»˜è®¤ 4
    """
    matplotlib.use('Agg')  # ä½¿ç”¨éäº¤äº’å¼åç«¯

    # 1. å¤„ç†æ ‡é¢˜ï¼ˆé•¿æ ‡é¢˜è‡ªåŠ¨æ¢è¡Œï¼‰
    title_sp = title.split(' ')
    if len(title_sp) > 20:
        title = '\n'.join([' '.join(title_sp[:10]), ' '.join(title_sp[10:20]), ' '.join(title_sp[20:])])
    elif len(title_sp) > 10:
        title = '\n'.join([' '.join(title_sp[:10]), ' '.join(title_sp[10:])])

    # 2. åˆå§‹åŒ–å‡½æ•°
    def init():
        ax.set_xlim3d([-radius / 2, radius / 2])
        ax.set_ylim3d([0, radius])
        ax.set_zlim3d([0, radius])
        fig.suptitle(title, fontsize=20)
        ax.grid(b=False)

    # 3. ç»˜åˆ¶åœ°é¢å¹³é¢
    def plot_xzPlane(minx, maxx, miny, minz, maxz):
        verts = [
            [minx, miny, minz],
            [minx, miny, maxz],
            [maxx, miny, maxz],
            [maxx, miny, minz]
        ]
        xz_plane = Poly3DCollection([verts])
        xz_plane.set_facecolor((0.5, 0.5, 0.5, 0.5))  # åŠé€æ˜ç°è‰²
        ax.add_collection3d(xz_plane)

    # 4. æ•°æ®é¢„å¤„ç†
    data = joints.copy().reshape(len(joints), -1, 3)
    fig = plt.figure(figsize=figsize)
    ax = p3.Axes3D(fig)
    init()
    
    # è®¡ç®—æ•°æ®çš„è¾¹ç•Œ
    MINS = data.min(axis=0).min(axis=0)
    MAXS = data.max(axis=0).max(axis=0)
    
    # å®šä¹‰éª¨éª¼é“¾çš„é¢œè‰²
    colors = ['red', 'blue', 'black', 'red', 'blue',
              'darkblue', 'darkblue', 'darkblue', 'darkblue', 'darkblue',
              'darkred', 'darkred', 'darkred', 'darkred', 'darkred']
    frame_number = data.shape[0]

    # 5. è°ƒæ•´é«˜åº¦ï¼ˆè®©äººç‰©ç«™åœ¨åœ°é¢ä¸Šï¼‰
    height_offset = MINS[1]
    data[:, :, 1] -= height_offset
    
    # æå–æ ¹èŠ‚ç‚¹çš„XZè½¨è¿¹ï¼ˆç”¨äºç»˜åˆ¶ç§»åŠ¨è·¯å¾„ï¼‰
    trajec = data[:, 0, [0, 2]]

    # 6. ç›¸å¯¹åæ ‡è½¬æ¢ï¼ˆè®©äººç‰©å§‹ç»ˆåœ¨ç”»é¢ä¸­å¿ƒï¼‰
    data[..., 0] -= data[:, 0:1, 0]
    data[..., 2] -= data[:, 0:1, 2]

    # 7. æ¯å¸§æ›´æ–°å‡½æ•°
    def update(index):
        ax.clear()
        ax.view_init(elev=120, azim=-90)  # è®¾ç½®è§†è§’
        ax.dist = 7.5
        ax.set_xlim3d([-radius / 2, radius / 2])
        ax.set_ylim3d([0, radius])
        ax.set_zlim3d([0, radius])
        ax.grid(b=False)
        
        # ç»˜åˆ¶åœ°é¢
        plot_xzPlane(MINS[0] - trajec[index, 0], MAXS[0] - trajec[index, 0], 0, 
                     MINS[2] - trajec[index, 1], MAXS[2] - trajec[index, 1])

        # ç»˜åˆ¶ç§»åŠ¨è½¨è¿¹
        if index > 1:
            ax.plot3D(trajec[:index, 0] - trajec[index, 0], 
                     np.zeros_like(trajec[:index, 0]),
                     trajec[:index, 1] - trajec[index, 1], 
                     linewidth=1.0, color='blue')

        # ç»˜åˆ¶éª¨éª¼é“¾
        for i, (chain, color) in enumerate(zip(kinematic_tree, colors)):
            if i < 5:
                linewidth = 4.0  # ä¸»è¦éª¨éª¼é“¾ç²—ä¸€äº›
            else:
                linewidth = 2.0
            ax.plot3D(data[index, chain, 0], data[index, chain, 1], 
                     data[index, chain, 2], linewidth=linewidth, color=color)

        plt.axis('off')
        ax.set_xticklabels([])
        ax.set_yticklabels([])
        ax.set_zticklabels([])

    # 8. åˆ›å»ºåŠ¨ç”»
    ani = FuncAnimation(fig, update, frames=frame_number, interval=1000 / fps, repeat=False)

    # 9. ä¿å­˜åŠ¨ç”»
    try:
        writer = FFMpegWriter(fps=fps, codec='mpeg4', extra_args=['-pix_fmt', 'yuv420p'])
        ani.save(save_path, writer=writer)
    except Exception:
        # å¦‚æœFFMpegå¤±è´¥ï¼Œå°è¯•ä¿å­˜ä¸ºGIF
        alt_path = save_path[:-4] + '.gif' if save_path.endswith('.mp4') else save_path + '.gif'
        writer = PillowWriter(fps=fps)
        ani.save(alt_path, writer=writer)
```

---

## ğŸ” ä»£ç è¯¦è§£

### 1. é¢œè‰²é…ç½®

```python
colors = ['red', 'blue', 'black', 'red', 'blue',
          'darkblue', 'darkblue', 'darkblue', 'darkblue', 'darkblue',
          'darkred', 'darkred', 'darkred', 'darkred', 'darkred']
```

å¯¹åº” `kinematic_tree` çš„5æ¡é“¾ï¼š
- **é“¾0 (å·¦è…¿)**: `red` (çº¢è‰²)
- **é“¾1 (å³è…¿)**: `blue` (è“è‰²)
- **é“¾2 (è„ŠæŸ±)**: `black` (é»‘è‰²)
- **é“¾3 (å·¦è‡‚)**: `red` (çº¢è‰²)
- **é“¾4 (å³è‡‚)**: `blue` (è“è‰²)

### 2. è§†è§’è®¾ç½®

```python
ax.view_init(elev=120, azim=-90)
ax.dist = 7.5
```

- `elev=120`: ä»°è§’120åº¦ï¼ˆä»ä¸Šå¾€ä¸‹çœ‹ï¼‰
- `azim=-90`: æ–¹ä½è§’-90åº¦ï¼ˆä»ä¾§é¢çœ‹ï¼‰
- `dist=7.5`: ç›¸æœºè·ç¦»

### 3. åæ ‡å½’ä¸€åŒ–

```python
# è®©äººç‰©ç«™åœ¨åœ°é¢ä¸Š
height_offset = MINS[1]
data[:, :, 1] -= height_offset

# è®©äººç‰©å§‹ç»ˆåœ¨ç”»é¢ä¸­å¿ƒ
data[..., 0] -= data[:, 0:1, 0]
data[..., 2] -= data[:, 0:1, 2]
```

### 4. è½¨è¿¹ç»˜åˆ¶

```python
trajec = data[:, 0, [0, 2]]  # æå–æ ¹èŠ‚ç‚¹çš„XZåæ ‡

# åœ¨æ¯å¸§ç»˜åˆ¶å†å²è½¨è¿¹
if index > 1:
    ax.plot3D(trajec[:index, 0] - trajec[index, 0], 
             np.zeros_like(trajec[:index, 0]),
             trajec[:index, 1] - trajec[index, 1], 
             linewidth=1.0, color='blue')
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```python
from utils.motion_process import plot_3d_motion, t2m_kinematic_chain
import numpy as np

# åŠ è½½motionæ•°æ®
motion = np.load('motion.npy')  # å½¢çŠ¶: (seq_len, 22, 3)

# ç”Ÿæˆå¯è§†åŒ–
plot_3d_motion(
    save_path='output.mp4',
    kinematic_tree=t2m_kinematic_chain,
    joints=motion,
    title='A person is walking',
    figsize=(10, 10),
    fps=20,
    radius=4
)
```

### è‡ªå®šä¹‰å‚æ•°

```python
# æ›´å¤§çš„ç”»é¢
plot_3d_motion(
    save_path='large_output.mp4',
    kinematic_tree=t2m_kinematic_chain,
    joints=motion,
    title='My Custom Motion',
    figsize=(16, 12),  # æ›´å¤§çš„å›¾å½¢
    fps=30,            # æ›´é«˜çš„å¸§ç‡
    radius=6           # æ›´å¤§çš„æ˜¾ç¤ºèŒƒå›´
)

# ä¿å­˜ä¸ºGIFï¼ˆå¦‚æœæ²¡æœ‰FFMpegï¼‰
plot_3d_motion(
    save_path='output.gif',
    kinematic_tree=t2m_kinematic_chain,
    joints=motion,
    title='Walking Motion',
    fps=15
)
```

---

## ğŸ› ï¸ è‡ªå®šä¹‰å¯è§†åŒ–

### ç¤ºä¾‹1: ä¿®æ”¹é¢œè‰²æ–¹æ¡ˆ

```python
def plot_3d_motion_custom_colors(save_path, kinematic_tree, joints, title, 
                                  figsize=(10, 10), fps=120, radius=4):
    matplotlib.use('Agg')
    
    # è‡ªå®šä¹‰é¢œè‰²ï¼šç»¿è‰²ä¸»é¢˜
    colors = ['green', 'lime', 'darkgreen', 'green', 'lime']
    
    # ... å…¶ä»–ä»£ç ç›¸åŒ ...
```

### ç¤ºä¾‹2: æ·»åŠ å…³èŠ‚ç‚¹æ ‡è®°

```python
def update(index):
    ax.clear()
    ax.view_init(elev=120, azim=-90)
    ax.dist = 7.5
    ax.set_xlim3d([-radius / 2, radius / 2])
    ax.set_ylim3d([0, radius])
    ax.set_zlim3d([0, radius])
    ax.grid(b=False)
    
    plot_xzPlane(MINS[0] - trajec[index, 0], MAXS[0] - trajec[index, 0], 0, 
                 MINS[2] - trajec[index, 1], MAXS[2] - trajec[index, 1])

    # ç»˜åˆ¶éª¨éª¼é“¾
    for i, (chain, color) in enumerate(zip(kinematic_tree, colors)):
        linewidth = 4.0 if i < 5 else 2.0
        ax.plot3D(data[index, chain, 0], data[index, chain, 1], 
                 data[index, chain, 2], linewidth=linewidth, color=color)
    
    # ğŸ†• æ·»åŠ å…³èŠ‚ç‚¹æ ‡è®°
    ax.scatter(data[index, :, 0], data[index, :, 1], data[index, :, 2], 
               c='red', marker='o', s=50, alpha=0.8)
    
    # ğŸ†• æ·»åŠ å…³èŠ‚ç‚¹ç¼–å·
    for joint_idx in range(data.shape[1]):
        ax.text(data[index, joint_idx, 0], 
                data[index, joint_idx, 1], 
                data[index, joint_idx, 2], 
                str(joint_idx), fontsize=8, color='black')
    
    plt.axis('off')
```

### ç¤ºä¾‹3: å¤šè§†è§’å¯¹æ¯”

```python
def plot_3d_motion_multi_view(save_path, kinematic_tree, joints, title, fps=20):
    """ä»å¤šä¸ªè§†è§’åŒæ—¶æ˜¾ç¤º"""
    matplotlib.use('Agg')
    
    data = joints.copy().reshape(len(joints), -1, 3)
    fig = plt.figure(figsize=(20, 5))
    
    # åˆ›å»º4ä¸ªå­å›¾ï¼Œä¸åŒè§†è§’
    views = [
        (120, -90, 'ä¿¯è§†å›¾'),   # ä»ä¸Šå¾€ä¸‹
        (90, -90, 'ä¾§è§†å›¾'),    # ä»ä¾§é¢
        (90, 0, 'æ­£è§†å›¾'),      # ä»æ­£é¢
        (110, -45, 'æ–œè§†å›¾')    # æ–œè§’
    ]
    
    axes = []
    for i, (elev, azim, view_title) in enumerate(views):
        ax = fig.add_subplot(1, 4, i+1, projection='3d')
        ax.set_title(view_title)
        axes.append((ax, elev, azim))
    
    # ... æ•°æ®é¢„å¤„ç† ...
    
    def update(index):
        for ax, elev, azim in axes:
            ax.clear()
            ax.view_init(elev=elev, azim=azim)
            # ... ç»˜åˆ¶ä»£ç  ...
    
    ani = FuncAnimation(fig, update, frames=len(data), interval=1000/fps, repeat=False)
    ani.save(save_path, writer=FFMpegWriter(fps=fps))
```

### ç¤ºä¾‹4: æ·»åŠ é€Ÿåº¦æŒ‡ç¤ºå™¨

```python
def plot_3d_motion_with_velocity(save_path, kinematic_tree, joints, title, fps=20):
    """æ˜¾ç¤ºå…³èŠ‚ç‚¹é€Ÿåº¦"""
    matplotlib.use('Agg')
    
    data = joints.copy().reshape(len(joints), -1, 3)
    
    # è®¡ç®—é€Ÿåº¦
    velocity = np.zeros_like(data)
    velocity[1:] = data[1:] - data[:-1]
    speed = np.linalg.norm(velocity, axis=2)  # (seq_len, num_joints)
    
    # ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
    
    def update(index):
        ax.clear()
        # ... åŸºç¡€ç»˜åˆ¶ä»£ç  ...
        
        # æ ¹æ®é€Ÿåº¦æ”¹å˜å…³èŠ‚ç‚¹é¢œè‰²
        joint_colors = plt.cm.hot(speed[index] / speed.max())
        ax.scatter(data[index, :, 0], data[index, :, 1], data[index, :, 2], 
                   c=joint_colors, marker='o', s=100, alpha=0.8)
        
        # æ·»åŠ é€Ÿåº¦æ¡
        ax.text2D(0.05, 0.95, f'Max Speed: {speed[index].max():.2f} m/frame', 
                  transform=ax.transAxes)
```

---

## ğŸ“Š å¯è§†åŒ–æ•ˆæœè¯´æ˜

### é»˜è®¤æ•ˆæœ

1. **åœ°é¢**: åŠé€æ˜ç°è‰²å¹³é¢
2. **éª¨éª¼**: å½©è‰²çº¿æ¡è¿æ¥å…³èŠ‚ç‚¹
   - å·¦è…¿/å·¦è‡‚: çº¢è‰²
   - å³è…¿/å³è‡‚: è“è‰²
   - è„ŠæŸ±: é»‘è‰²
3. **è½¨è¿¹**: è“è‰²çº¿æ¡æ˜¾ç¤ºæ ¹èŠ‚ç‚¹ç§»åŠ¨è·¯å¾„
4. **è§†è§’**: ä»æ–œä¸Šæ–¹ä¿¯è§†

### è§†è§’å‚æ•°å¯¹æ¯”

| å‚æ•° | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| `elev=120, azim=-90` | ä¿¯è§† | é»˜è®¤ï¼Œçœ‹æ¸…æ•´ä½“åŠ¨ä½œ |
| `elev=90, azim=-90` | ä¾§è§† | è§‚å¯Ÿå‰åç§»åŠ¨ |
| `elev=90, azim=0` | æ­£è§† | è§‚å¯Ÿå·¦å³ç§»åŠ¨ |
| `elev=110, azim=-45` | æ–œè§† | ç«‹ä½“æ„Ÿå¼º |

---

## ğŸ¬ åŠ¨ç”»ç”Ÿæˆæµç¨‹

```
1. åŠ è½½å…³èŠ‚ç‚¹æ•°æ® (seq_len, 22, 3)
         â†“
2. æ•°æ®é¢„å¤„ç†ï¼ˆå½’ä¸€åŒ–ã€è°ƒæ•´é«˜åº¦ï¼‰
         â†“
3. åˆ›å»ºmatplotlibå›¾å½¢å’Œ3Dåæ ‡è½´
         â†“
4. å¯¹æ¯ä¸€å¸§æ‰§è¡Œupdate()å‡½æ•°
   - æ¸…ç©ºç”»å¸ƒ
   - ç»˜åˆ¶åœ°é¢
   - ç»˜åˆ¶è½¨è¿¹
   - ç»˜åˆ¶éª¨éª¼é“¾
         â†“
5. ä½¿ç”¨FuncAnimationåˆ›å»ºåŠ¨ç”»å¯¹è±¡
         â†“
6. ä¿å­˜ä¸ºMP4ï¼ˆæˆ–GIFï¼‰
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç”Ÿæˆçš„è§†é¢‘æ˜¯é»‘å±

**åŸå› **: æ•°æ®èŒƒå›´è¶…å‡ºæ˜¾ç¤ºèŒƒå›´

**è§£å†³**:
```python
# å¢å¤§radiuså‚æ•°
plot_3d_motion(..., radius=8)  # é»˜è®¤æ˜¯4

# æˆ–è€…æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®
print(f"æ•°æ®èŒƒå›´: {motion.min():.2f} ~ {motion.max():.2f}")
```

### Q2: FFMpegé”™è¯¯

**åŸå› **: ç³»ç»Ÿæœªå®‰è£…FFMpeg

**è§£å†³**:
```bash
# Ubuntu/Debian
sudo apt-get install ffmpeg

# æˆ–è€…ä¿å­˜ä¸ºGIF
plot_3d_motion('output.gif', ...)
```

### Q3: åŠ¨ç”»å¤ªå¿«æˆ–å¤ªæ…¢

**è§£å†³**:
```python
# è°ƒæ•´fpså‚æ•°
plot_3d_motion(..., fps=20)   # æ…¢é€Ÿ
plot_3d_motion(..., fps=60)   # å¿«é€Ÿ
plot_3d_motion(..., fps=120)  # é»˜è®¤
```

### Q4: äººç‰©å€’ç«‹æˆ–æ–¹å‘é”™è¯¯

**åŸå› **: åæ ‡ç³»ä¸ä¸€è‡´

**è§£å†³**:
```python
# è°ƒæ•´è§†è§’å‚æ•°
ax.view_init(elev=120, azim=-90)  # æ ‡å‡†è§†è§’
ax.view_init(elev=-120, azim=90)  # ç¿»è½¬è§†è§’
```

---

## ğŸ“¦ ä¾èµ–åº“

```python
import matplotlib
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation, FFMpegWriter, PillowWriter
from mpl_toolkits.mplot3d.art3d import Poly3DCollection
import mpl_toolkits.mplot3d.axes3d as p3
import numpy as np
```

**å®‰è£…**:
```bash
pip install matplotlib numpy
```

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

1. **`utils/motion_process.py`** - å¯è§†åŒ–ä¸»ä»£ç 
2. **`sample.py`** (ç¬¬147è¡Œ) - è°ƒç”¨å¯è§†åŒ–
3. **`sample_flexible.py`** (ç¬¬159è¡Œ) - è°ƒç”¨å¯è§†åŒ–

---

## ğŸ’¡ è¿›é˜¶æŠ€å·§

### 1. æ‰¹é‡å¯è§†åŒ–

```python
import os
import glob

npy_files = glob.glob('./generation/**/*.npy', recursive=True)

for npy_file in npy_files:
    motion = np.load(npy_file)
    output_path = npy_file.replace('.npy', '.mp4')
    
    if not os.path.exists(output_path):
        plot_3d_motion(output_path, t2m_kinematic_chain, motion, 
                      title=os.path.basename(npy_file), fps=20)
        print(f"âœ… {output_path}")
```

### 2. å®æ—¶é¢„è§ˆï¼ˆJupyter Notebookï¼‰

```python
%matplotlib notebook
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D

motion = np.load('motion.npy')
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

# ä½¿ç”¨æ»‘å—æ§åˆ¶å¸§
from ipywidgets import interact

@interact(frame=(0, len(motion)-1))
def show_frame(frame=0):
    ax.clear()
    joints = motion[frame]
    ax.scatter(joints[:, 0], joints[:, 1], joints[:, 2])
    # ç»˜åˆ¶éª¨éª¼...
```

### 3. å¯¼å‡ºä¸ºå›¾ç‰‡åºåˆ—

```python
def save_frames_as_images(joints, output_dir, kinematic_tree):
    """ä¿å­˜æ¯ä¸€å¸§ä¸ºç‹¬ç«‹å›¾ç‰‡"""
    os.makedirs(output_dir, exist_ok=True)
    
    for frame_idx in range(len(joints)):
        fig = plt.figure(figsize=(10, 10))
        ax = fig.add_subplot(111, projection='3d')
        
        # ç»˜åˆ¶å½“å‰å¸§
        data = joints[frame_idx]
        for chain in kinematic_tree:
            ax.plot3D(data[chain, 0], data[chain, 1], data[chain, 2])
        
        plt.savefig(f'{output_dir}/frame_{frame_idx:04d}.png')
        plt.close()
```

---

## ğŸ“ æ€»ç»“

- **ä¸»æ–‡ä»¶**: `utils/motion_process.py`
- **æ ¸å¿ƒå‡½æ•°**: `plot_3d_motion()`
- **è¾“å…¥**: å…³èŠ‚ç‚¹åæ ‡ `(seq_len, 22, 3)`
- **è¾“å‡º**: MP4è§†é¢‘æˆ–GIFåŠ¨ç”»
- **å¯å®šåˆ¶**: é¢œè‰²ã€è§†è§’ã€å¸§ç‡ã€æ˜¾ç¤ºèŒƒå›´

ç°åœ¨ä½ å¯ä»¥å‚è€ƒè¿™äº›ä»£ç æ¥åˆ›å»ºè‡ªå·±çš„å¯è§†åŒ–æ•ˆæœäº†ï¼ğŸ¨

