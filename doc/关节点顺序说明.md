# MARDM ç”Ÿæˆç»“æœä¸­çš„å…³èŠ‚ç‚¹é¡ºåºè¯´æ˜

## ğŸ“Š NPYæ–‡ä»¶æ•°æ®ç»“æ„

ç”Ÿæˆçš„ `.npy` æ–‡ä»¶åŒ…å«3Då…³èŠ‚ç‚¹åæ ‡æ•°æ®ï¼š

- **å½¢çŠ¶**: `(seq_len, num_joints, 3)`
  - `seq_len`: åŠ¨ä½œåºåˆ—é•¿åº¦ï¼ˆå¸§æ•°ï¼‰
  - `num_joints`: å…³èŠ‚ç‚¹æ•°é‡ï¼ˆHumanML3D: 22ä¸ªï¼ŒKIT: 21ä¸ªï¼‰
  - `3`: XYZåæ ‡

- **æ•°æ®ç±»å‹**: `float32`
- **åæ ‡ç³»**: ä¸–ç•Œåæ ‡ç³»ï¼Œå•ä½ä¸ºç±³

**ç¤ºä¾‹ï¼š**
```python
import numpy as np
data = np.load('motion.npy')
print(data.shape)  # (60, 22, 3) - 60å¸§ï¼Œ22ä¸ªå…³èŠ‚ç‚¹ï¼ŒXYZåæ ‡
```

---

## ğŸ¦´ HumanML3D æ•°æ®é›† (22ä¸ªå…³èŠ‚ç‚¹)

### å…³èŠ‚ç‚¹ç´¢å¼•å’Œåç§°

æ ¹æ® `t2m_kinematic_chain` çš„å®šä¹‰ï¼Œ22ä¸ªå…³èŠ‚ç‚¹çš„æ‹“æ‰‘ç»“æ„å¦‚ä¸‹ï¼š

```python
t2m_kinematic_chain = [
    [0, 2, 5, 8, 11],      # é“¾1: å·¦è…¿
    [0, 1, 4, 7, 10],      # é“¾2: å³è…¿  
    [0, 3, 6, 9, 12, 15],  # é“¾3: è„ŠæŸ±åˆ°å¤´éƒ¨
    [9, 14, 17, 19, 21],   # é“¾4: å·¦è‡‚
    [9, 13, 16, 18, 20]    # é“¾5: å³è‡‚
]
```

### å…³èŠ‚ç‚¹è¯¦ç»†åˆ—è¡¨

| ç´¢å¼• | å…³èŠ‚ç‚¹åç§° | è‹±æ–‡åç§° | æ‰€å±é“¾ | è¯´æ˜ |
|------|-----------|---------|--------|------|
| **0** | éª¨ç›†/æ ¹èŠ‚ç‚¹ | Pelvis/Root | æ‰€æœ‰é“¾çš„èµ·ç‚¹ | èº«ä½“ä¸­å¿ƒ |
| **1** | å³é«‹ | Right Hip | å³è…¿é“¾ | |
| **2** | å·¦é«‹ | Left Hip | å·¦è…¿é“¾ | |
| **3** | è„ŠæŸ±1 | Spine1 | è„ŠæŸ±é“¾ | ä¸‹è„ŠæŸ± |
| **4** | å³è† | Right Knee | å³è…¿é“¾ | |
| **5** | å·¦è† | Left Knee | å·¦è…¿é“¾ | |
| **6** | è„ŠæŸ±2 | Spine2 | è„ŠæŸ±é“¾ | ä¸­è„ŠæŸ± |
| **7** | å³è„šè¸ | Right Ankle | å³è…¿é“¾ | |
| **8** | å·¦è„šè¸ | Left Ankle | å·¦è…¿é“¾ | |
| **9** | è„ŠæŸ±3 | Spine3 | è„ŠæŸ±é“¾/è‚©éƒ¨èµ·ç‚¹ | ä¸Šè„ŠæŸ±/é¢ˆéƒ¨ |
| **10** | å³è„š | Right Foot | å³è…¿é“¾ | è„šå°– |
| **11** | å·¦è„š | Left Foot | å·¦è…¿é“¾ | è„šå°– |
| **12** | é¢ˆéƒ¨ | Neck | è„ŠæŸ±é“¾ | |
| **13** | å³é”éª¨ | Right Collar | å³è‡‚é“¾ | |
| **14** | å·¦é”éª¨ | Left Collar | å·¦è‡‚é“¾ | |
| **15** | å¤´éƒ¨ | Head | è„ŠæŸ±é“¾ | å¤´é¡¶ |
| **16** | å³è‚© | Right Shoulder | å³è‡‚é“¾ | |
| **17** | å·¦è‚© | Left Shoulder | å·¦è‡‚é“¾ | |
| **18** | å³è‚˜ | Right Elbow | å³è‡‚é“¾ | |
| **19** | å·¦è‚˜ | Left Elbow | å·¦è‡‚é“¾ | |
| **20** | å³æ‰‹è…• | Right Wrist | å³è‡‚é“¾ | |
| **21** | å·¦æ‰‹è…• | Left Wrist | å·¦è‡‚é“¾ | |

### éª¨éª¼æ‹“æ‰‘ç»“æ„å¯è§†åŒ–

```
                    15 (å¤´éƒ¨)
                     |
                    12 (é¢ˆéƒ¨)
                     |
    21 (å·¦æ‰‹è…•)     9 (è„ŠæŸ±3/é¢ˆéƒ¨)      20 (å³æ‰‹è…•)
         |          |                    |
    19 (å·¦è‚˜)      |                18 (å³è‚˜)
         |          |                    |
    17 (å·¦è‚©)      |                16 (å³è‚©)
         |          |                    |
    14 (å·¦é”éª¨)    |                13 (å³é”éª¨)
          \        |                   /
           \       6 (è„ŠæŸ±2)          /
            \      |                 /
             \     3 (è„ŠæŸ±1)        /
              \    |               /
               \   |              /
                \  0 (éª¨ç›†)      /
                / |  \
               /  |   \
    2 (å·¦é«‹)  /   |    \  1 (å³é«‹)
         |                    |
    5 (å·¦è†)              4 (å³è†)
         |                    |
    8 (å·¦è„šè¸)            7 (å³è„šè¸)
         |                    |
    11 (å·¦è„š)             10 (å³è„š)
```

### è¿åŠ¨é“¾è¯´æ˜

1. **å·¦è…¿é“¾** `[0â†’2â†’5â†’8â†’11]`: éª¨ç›† â†’ å·¦é«‹ â†’ å·¦è† â†’ å·¦è„šè¸ â†’ å·¦è„š
2. **å³è…¿é“¾** `[0â†’1â†’4â†’7â†’10]`: éª¨ç›† â†’ å³é«‹ â†’ å³è† â†’ å³è„šè¸ â†’ å³è„š
3. **è„ŠæŸ±é“¾** `[0â†’3â†’6â†’9â†’12â†’15]`: éª¨ç›† â†’ è„ŠæŸ±1 â†’ è„ŠæŸ±2 â†’ è„ŠæŸ±3 â†’ é¢ˆéƒ¨ â†’ å¤´éƒ¨
4. **å·¦è‡‚é“¾** `[9â†’14â†’17â†’19â†’21]`: è„ŠæŸ±3 â†’ å·¦é”éª¨ â†’ å·¦è‚© â†’ å·¦è‚˜ â†’ å·¦æ‰‹è…•
5. **å³è‡‚é“¾** `[9â†’13â†’16â†’18â†’20]`: è„ŠæŸ±3 â†’ å³é”éª¨ â†’ å³è‚© â†’ å³è‚˜ â†’ å³æ‰‹è…•

---

## ğŸ¦´ KIT æ•°æ®é›† (21ä¸ªå…³èŠ‚ç‚¹)

### å…³èŠ‚ç‚¹ç´¢å¼•

```python
kit_kinematic_chain = [
    [0, 11, 12, 13, 14, 15],  # é“¾1
    [0, 16, 17, 18, 19, 20],  # é“¾2
    [0, 1, 2, 3, 4],          # é“¾3
    [3, 5, 6, 7],             # é“¾4
    [3, 8, 9, 10]             # é“¾5
]
```

KITæ•°æ®é›†ä½¿ç”¨21ä¸ªå…³èŠ‚ç‚¹ï¼Œæ‹“æ‰‘ç»“æ„ä¸HumanML3Dç•¥æœ‰ä¸åŒã€‚

---

## ğŸ’¾ æ•°æ®è®¿é—®ç¤ºä¾‹

### è¯»å–NPYæ–‡ä»¶

```python
import numpy as np

# åŠ è½½ç”Ÿæˆçš„motionæ•°æ®
motion_data = np.load('caption:A person walks._sample0_repeat0_len120.npy')

print(f"æ•°æ®å½¢çŠ¶: {motion_data.shape}")  # (120, 22, 3)
print(f"å¸§æ•°: {motion_data.shape[0]}")    # 120
print(f"å…³èŠ‚ç‚¹æ•°: {motion_data.shape[1]}")  # 22

# è®¿é—®ç‰¹å®šå¸§çš„ç‰¹å®šå…³èŠ‚ç‚¹
frame_idx = 0
joint_idx = 15  # å¤´éƒ¨

head_position = motion_data[frame_idx, joint_idx, :]
print(f"ç¬¬{frame_idx}å¸§ï¼Œå¤´éƒ¨ä½ç½®(XYZ): {head_position}")

# è®¿é—®æŸä¸ªå…³èŠ‚ç‚¹çš„æ•´ä¸ªè¿åŠ¨è½¨è¿¹
right_hand_trajectory = motion_data[:, 20, :]  # å³æ‰‹è…•çš„è½¨è¿¹
print(f"å³æ‰‹è…•è½¨è¿¹å½¢çŠ¶: {right_hand_trajectory.shape}")  # (120, 3)
```

### æå–ç‰¹å®šèº«ä½“éƒ¨ä½

```python
import numpy as np

motion = np.load('motion.npy')

# æå–å·¦è‡‚æ‰€æœ‰å…³èŠ‚ç‚¹ï¼ˆç´¢å¼•ï¼š14, 17, 19, 21ï¼‰
left_arm_joints = motion[:, [14, 17, 19, 21], :]
print(f"å·¦è‡‚å…³èŠ‚ç‚¹: {left_arm_joints.shape}")  # (seq_len, 4, 3)

# æå–åŒè…¿ï¼ˆç´¢å¼•ï¼š0, 1, 2, 4, 5, 7, 8, 10, 11ï¼‰
leg_joints = motion[:, [0, 1, 2, 4, 5, 7, 8, 10, 11], :]

# æå–è„ŠæŸ±é“¾ï¼ˆç´¢å¼•ï¼š0, 3, 6, 9, 12, 15ï¼‰
spine_joints = motion[:, [0, 3, 6, 9, 12, 15], :]
```

### è®¡ç®—å…³èŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»

```python
import numpy as np

motion = np.load('motion.npy')

# è®¡ç®—åŒæ‰‹ä¹‹é—´çš„è·ç¦»ï¼ˆæ¯ä¸€å¸§ï¼‰
left_wrist = motion[:, 21, :]   # å·¦æ‰‹è…•
right_wrist = motion[:, 20, :]  # å³æ‰‹è…•

hand_distance = np.linalg.norm(left_wrist - right_wrist, axis=1)
print(f"åŒæ‰‹è·ç¦»å˜åŒ–: {hand_distance.shape}")  # (seq_len,)
print(f"å¹³å‡è·ç¦»: {hand_distance.mean():.3f} ç±³")
print(f"æœ€å¤§è·ç¦»: {hand_distance.max():.3f} ç±³")
```

### è®¡ç®—å…³èŠ‚ç‚¹é€Ÿåº¦

```python
import numpy as np

motion = np.load('motion.npy')

# è®¡ç®—å³æ‰‹è…•çš„é€Ÿåº¦
right_wrist = motion[:, 20, :]
velocity = np.diff(right_wrist, axis=0)  # ç›¸é‚»å¸§çš„ä½ç§»
speed = np.linalg.norm(velocity, axis=1)  # é€Ÿåº¦å¤§å°

print(f"å³æ‰‹è…•å¹³å‡é€Ÿåº¦: {speed.mean():.3f} ç±³/å¸§")
```

---

## ğŸ”„ åæ ‡ç³»è¯´æ˜

### ä¸–ç•Œåæ ‡ç³»

- **Xè½´**: å·¦å³æ–¹å‘ï¼ˆæ­£æ–¹å‘ä¸ºå³ï¼‰
- **Yè½´**: ä¸Šä¸‹æ–¹å‘ï¼ˆæ­£æ–¹å‘ä¸ºä¸Šï¼‰
- **Zè½´**: å‰åæ–¹å‘ï¼ˆæ­£æ–¹å‘ä¸ºå‰ï¼‰

### æ ¹èŠ‚ç‚¹ï¼ˆç´¢å¼•0ï¼‰

- éª¨ç›†ä½ç½®ä½œä¸ºæ•´ä¸ªéª¨éª¼çš„æ ¹èŠ‚ç‚¹
- å…¶ä»–æ‰€æœ‰å…³èŠ‚ç‚¹çš„ä½ç½®éƒ½æ˜¯ä¸–ç•Œåæ ‡
- åŠ¨ä½œç”Ÿæˆæ—¶ï¼Œæ ¹èŠ‚ç‚¹å¯ä»¥åœ¨XZå¹³é¢ä¸Šç§»åŠ¨

---

## ğŸ“ æ•°æ®å½’ä¸€åŒ–

### Mean å’Œ Std

ç”Ÿæˆè¿‡ç¨‹ä¸­ä½¿ç”¨äº†æ•°æ®å½’ä¸€åŒ–ï¼š

```python
# åœ¨sample.pyä¸­çš„å¤„ç†
mean = np.load('./datasets/HumanML3D/Mean.npy')  # å½¢çŠ¶: (67,)
std = np.load('./datasets/HumanML3D/Std.npy')    # å½¢çŠ¶: (67,)

# åå½’ä¸€åŒ–
data = pred_motions * std + mean
```

**æ³¨æ„**: Meanå’ŒStdæ˜¯é’ˆå¯¹åŸå§‹ç‰¹å¾è¡¨ç¤ºï¼ˆ67ç»´ï¼‰ï¼Œè€Œä¸æ˜¯ç›´æ¥çš„å…³èŠ‚ç‚¹åæ ‡ã€‚

### ç‰¹å¾è¡¨ç¤º

NPYæ–‡ä»¶ä¸­çš„æ•°æ®å·²ç»é€šè¿‡ `recover_from_ric()` å‡½æ•°ä»å‹ç¼©çš„ç‰¹å¾è¡¨ç¤ºæ¢å¤ä¸º3Då…³èŠ‚ç‚¹åæ ‡ï¼š

```python
# ä»RICè¡¨ç¤ºæ¢å¤ä¸º3Dåæ ‡
joint = recover_from_ric(torch.from_numpy(joint_data).float(), nb_joints).numpy()
```

---

## ğŸ¨ å¯è§†åŒ–

### ä½¿ç”¨å†…ç½®å‡½æ•°

```python
from utils.motion_process import plot_3d_motion, t2m_kinematic_chain
import numpy as np

motion = np.load('motion.npy')

plot_3d_motion(
    save_path='output.mp4',
    kinematic_tree=t2m_kinematic_chain,
    joints=motion,
    title='My Motion',
    fps=20,
    radius=4
)
```

### è‡ªå®šä¹‰å¯è§†åŒ–

```python
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
import numpy as np

motion = np.load('motion.npy')
frame_idx = 0

fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

# ç»˜åˆ¶å…³èŠ‚ç‚¹
joints = motion[frame_idx]
ax.scatter(joints[:, 0], joints[:, 1], joints[:, 2], c='red', marker='o')

# ç»˜åˆ¶éª¨éª¼è¿æ¥
t2m_kinematic_chain = [
    [0, 2, 5, 8, 11],
    [0, 1, 4, 7, 10],
    [0, 3, 6, 9, 12, 15],
    [9, 14, 17, 19, 21],
    [9, 13, 16, 18, 20]
]

for chain in t2m_kinematic_chain:
    for i in range(len(chain) - 1):
        j1, j2 = chain[i], chain[i+1]
        ax.plot([joints[j1, 0], joints[j2, 0]],
                [joints[j1, 1], joints[j2, 1]],
                [joints[j1, 2], joints[j2, 2]], 'b-')

ax.set_xlabel('X')
ax.set_ylabel('Y')
ax.set_zlabel('Z')
plt.show()
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ˜¯22ä¸ªå…³èŠ‚ç‚¹è€Œä¸æ˜¯æ›´å¤šï¼Ÿ

**A**: HumanML3Dä½¿ç”¨ç®€åŒ–çš„éª¨éª¼æ¨¡å‹ï¼Œä¸åŒ…å«æ‰‹æŒ‡ã€è„šè¶¾ç­‰ç»†èŠ‚å…³èŠ‚ã€‚è¿™æ˜¯ä¸ºäº†ï¼š
- é™ä½è®¡ç®—å¤æ‚åº¦
- ä¸“æ³¨äºå…¨èº«å¤§å¹…åº¦åŠ¨ä½œ
- ä¸SMPLç­‰äººä½“æ¨¡å‹å…¼å®¹

### Q2: å¦‚ä½•è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼ï¼ˆå¦‚BVHã€FBXï¼‰ï¼Ÿ

**A**: éœ€è¦é¢å¤–çš„è½¬æ¢å·¥å…·ï¼Œå¯ä»¥å‚è€ƒï¼š
- `motion-to-bvh` åº“
- Blender Python API
- è‡ªå®šä¹‰è½¬æ¢è„šæœ¬

### Q3: åæ ‡å•ä½æ˜¯ä»€ä¹ˆï¼Ÿ

**A**: å•ä½æ˜¯ç±³ï¼ˆmeterï¼‰ã€‚ä¸€ä¸ªæ ‡å‡†æˆå¹´äººçš„èº«é«˜çº¦ä¸º1.7ç±³ã€‚

### Q4: å¦‚ä½•åˆ¤æ–­åŠ¨ä½œçš„è´¨é‡ï¼Ÿ

**A**: å¯ä»¥æ£€æŸ¥ï¼š
- å…³èŠ‚ç‚¹ä½ç½®çš„åˆç†æ€§ï¼ˆä¸åº”ç©¿æ¨¡ï¼‰
- è¿åŠ¨çš„å¹³æ»‘æ€§ï¼ˆé€Ÿåº¦å’ŒåŠ é€Ÿåº¦ï¼‰
- ä¸æ–‡æœ¬æè¿°çš„åŒ¹é…åº¦
- ç‰©ç†çº¦æŸï¼ˆå¦‚è„šä¸åº”ç©¿è¿‡åœ°é¢ï¼‰

### Q5: å·¦å³æ˜¯ä»å“ªä¸ªè§†è§’å®šä¹‰çš„ï¼Ÿ

**A**: å·¦å³æ˜¯ä»**äººç‰©è‡ªèº«çš„è§†è§’**å®šä¹‰çš„ï¼Œä¸æ˜¯è§‚å¯Ÿè€…çš„è§†è§’ã€‚

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **ä»£ç **: `utils/motion_process.py` - åŒ…å«kinematic_chainå®šä¹‰å’Œå¯è§†åŒ–å‡½æ•°
- **æ•°æ®**: `datasets/HumanML3D/Mean.npy`, `Std.npy` - å½’ä¸€åŒ–å‚æ•°
- **ç”Ÿæˆè„šæœ¬**: `sample.py`, `sample_flexible.py` - ç”Ÿæˆmotionçš„ä¸»è„šæœ¬

---

## ğŸ”— å‚è€ƒèµ„æº

1. **HumanML3D è®ºæ–‡**: [HumanML3D: 3D Human Motion-Language Dataset](https://github.com/EricGuo5513/HumanML3D)
2. **SMPL æ¨¡å‹**: [SMPL: A Skinned Multi-Person Linear Model](https://smpl.is.tue.mpg.de/)
3. **è¿åŠ¨å­¦é“¾**: Kinematic Chain - æè¿°éª¨éª¼çˆ¶å­å…³ç³»çš„æ‹“æ‰‘ç»“æ„

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-12-02**: åˆ›å»ºåˆå§‹æ–‡æ¡£ï¼Œè¯¦ç»†è¯´æ˜HumanML3Dçš„22ä¸ªå…³èŠ‚ç‚¹é¡ºåº

